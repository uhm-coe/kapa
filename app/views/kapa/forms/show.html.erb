<% content_for(:box1) do %>

  <h3 class="center"><%=@form.name %></h3>
  <div class="row">
    <div class="col-sm-6">
      <h4>Form ID: <%=@form.id %></h4>
    </div>
    <div class="col-sm-6">
      <h4><%=@person.full_name %> (<%=@person.id_number %>)</h4>
    </div>
  </div>

  <%=bootstrap_form_for :form, :url => kapa_form_path(:id => @form), :html => {:method => :put} do %>

    <% if @form_template.type == "complex" %>
      <%=render :partial => @form_template.template_path, :locals => {:context => :kapa} %>
    <% else %>
      <%=bootstrap_fields_for :form_ext do |f| %>
        <% @form_template.form_fields.each do |form_field| %>
          <% if form_field.type == "section" %>
            <%=content_tag :legend, form_field.label %>
          <% elsif form_field.type == "text_field" %>
            <%=f.text_field form_field.label %>
          <% elsif form_field.type == "text_area" %>
            <%=f.text_area form_field.label %>
          <% elsif form_field.type == "property_select" %>
            <%=f.property_select form_field.label, :name => form_field.type_option %>
          <% elsif form_field.type == "csv_select" %>
            <%=f.select form_field.label, form_field.type_option.to_s.split(/,\s*/) %>
          <% end %>
        <% end %>
      <% end %>
    <% end %>
    <%=hidden_field :form, :person_id %>
    <%=hidden_field :form, :type %>

    <%= render :layout => "/kapa/layouts/controls", :locals => {:delete_path => kapa_form_path(:id => @form, :return_path => params[:return_path])} do %>
      <%=button_to_link "Setting", nil, "data-toggle" => "modal", "data-target" => "#edit_form_dialog", :icon => "glyphicon-wrench" %>
    <% end if write? %>

    <% if @form_template.attachment %>
      <legend>File Attachments</legend>
      <p class="right">
        <%=button_to_link "New File", nil, "data-toggle" => "modal", "data-target" => "#document_dialog", :icon => "glyphicon-plus" %>
      </p>

      <table class="table table-hover">
        <thead>
         <tr>
           <th>Type</th>
           <th>Name</th>
           <th>Date</th>
           <th></th>
         </tr>
        </thead>
        <tbody>
         <% @form.files.sort_by {|d| d.created_at}.reverse_each do |d| %>
           <tr>
             <td><%=d.type%></td>
             <td><%=d.name%></td>
             <td><%=format_date d.date %></td>
             <td class="right"><%=link_to "Show", kapa_file_path(:id => d), :target => "_blank", :class => "btn btn-default btn-xs" %></td>
           </tr>
         <% end %>
        </tbody>
      </table>
    <% end %>

  <% end %>

  <%=render :layout => '/kapa/layouts/modal', :locals => {:modal_id => "document_dialog", :modal_title => "Select a document", :modal_form_id => "new_document_form"} do %>
    <%=bootstrap_form_for :file, :url => kapa_files_path(:id => @person, :return_path => url_for(:only_path => true)), :html => {:multipart => true, :id => "new_document_form"} do |f| %>
      <%=f.file_field :data, :label => "File to upload" %>
      <%=f.hidden_field :attachable_type, :value => @form.class.name %>
      <%=f.hidden_field :attachable_id, :value => @form.id %>
      <%=f.hidden_field :person_id, :value => @form.person_id %>
    <% end %>
  <% end %>

  <%=render :layout => '/kapa/layouts/modal', :locals => {:modal_id => "edit_form_dialog", :modal_title => "Edit form property", :modal_form_id => "edit_form_form"} do %>
    <%=bootstrap_form_for(:form, :url => kapa_form_path(:id => @form), :html => {:method => :put, :id => "edit_form_form"}) do |f| %>
      <%=f.text_area :note, :label => "Note", :size => "5x7" %>
      <div class="row form-block">
        <div class="col-sm-4">
          <%=f.select :lock, [["Lock", "Y"], ["Unlock", "N"]], :label => "Lock status" %>
        </div>
      </div>
    <% end %>
  <% end %>
<% end %>
