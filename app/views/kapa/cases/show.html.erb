<% content_for(:head) do %>
  <style type="text/css">
    #involved_persons-rows tr {
      cursor: move;
    }
    .handle {
      padding: 5px;
    }
  </style>
<% end %>

<% content_for(:dialog) do %>
  <%= render :layout => '/kapa/layouts/modal', :locals => {:modal_id => "add_involved_person_dialog", :modal_title => "Add Person Involved", :modal_form_id => "add_case_involved_person_form" } do %>
    <%= bootstrap_form_for(:case_involved_person, :url => kapa_case_involved_persons_path(:case_id => @case), :html => {:id => "add_case_involved_person_form"}) do %>
      <%= render "kapa/case_involved_persons/involved_person_form" %>
    <% end %>
  <% end %>
<% end %>

<% content_for(:box1) do %>
  <%= render :partial => "/kapa/persons/person_detail" %>

  <h4 class="section-header divider">
     Case #<%=@case.id %>
  </h4>

  <div class="tabs">
    <ul class="nav nav-tabs">
      <li><a href="#case_tab" data-toggle="tab">Profile</a></li>
      <li><a href="#involved_person_tab" data-toggle="tab">Parties Involved</a></li>
      <li><a href="#actions_tab" data-toggle="tab">Actions</a></li>
    </ul>

    <div class="tab-content">
      <div id="case_tab" class="tab-pane">
        <%= bootstrap_form_for :case, :url => kapa_case_path(:id => @case, :anchor => :case), :html => {:method => :put} do %>
          <%= render :partial => "case_form" %>
        <% end %>
      </div>

      <div id="involved_person_tab" class="tab-pane">
        <p class="text-right">
          <button type="button" class="btn btn-default" data-toggle="modal" data-target="#add_involved_person_dialog"><span class="glyphicon glyphicon-plus"></span> Add Person</button>
        </p>
          <table id="involved_persons" class="table table-striped">
            <thead>
              <tr>
                <th>Type</th>
                <th>Name</th>
                <th>Phone</th>
                <th>E-mail</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="involved_persons-rows">
              <% for involved_person in @involved_persons %>
                <tr>
                  <td>
                    <%=involved_person.type %>
                  </td>
                  <td>
                    <% if involved_person.internal? %>
                      <%= link_to involved_person.full_name, kapa_person_path(:id => involved_person.person_id) %>
                    <% else %>
                      <%= involved_person.full_name %>
                    <% end %>
                  </td>
                  <td>
                    <%=involved_person.phone %>
                  </td>
                  <td>
                    <%=involved_person.email %>
                  </td>
                  <td class="right">
                    <%= link_to "Edit", kapa_case_involved_person_path(:id => involved_person), :class => "btn btn-default btn-xs" %>
                    <%= link_to "Delete", kapa_case_involved_person_path(:id => involved_person, :case_involved_person_id => @case_involved_person), :method => :delete, :class => "btn btn-default btn-xs" %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
      </div>

      <div id="actions_tab" class="tab-pane">
        <div class="panel-group" id="accordion">

          <% @case_actions.each_with_index do |case_action, index| %>
            <% @case_action = case_action %>
            <div class="panel panel-default">
              <div class="panel-heading">
                <h3 class="panel-title">
                  <a data-toggle="collapse" data-parent="#accordion" href="#case_action_<%= @case_action.id %>"><span class="strong"><%= format_date @case_action.action_date %>
                    - <%= h @case_action.action_desc %> <%="(#{@case_action.action_specify})" if @case_action.action_specify.present? %></span></a>
                </h3>
              </div>
              <div id="case_action_<%= @case_action.id %>" class="panel-collapse collapse<%= ' in' if params[:action_panel] == @case_action.id.to_s || (params[:action_panel].nil? && index == 0) %>">
                <div class="panel-body">
                  <%= bootstrap_form_for :case_action, :url => kapa_case_action_path(:id => @case_action, :anchor => :actions, :action_panel => @case_action.id), :html => {:method => :put} do |f| %>
                    <%= render :partial => "case_action_form" %>
                    <%= render :partial => "/kapa/layouts/controls", :locals => {:delete_path => kapa_case_action_path(:id => @case_action, :anchor => :actions)} if @current_user.write?(:kapa_case_actions) %>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>

          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#new_case_action"><span class="new">New Action </span></a>
              </h3>
            </div>

            <div id="new_case_action" class="panel-collapse collapse<%= ' in' if @case_actions.length == 0 %>">
              <div class="panel-body">
                <% @case_action = @case.case_actions.build(:user_id => @current_user.id, :action_date => Date.today) %>
                <%= bootstrap_form_for :case_action, :url => kapa_case_actions_path(:id => @case, :anchor => :actions) do %>
                  <%= render :partial => "case_action_form" %>
                  <%= render :partial => "/kapa/layouts/controls" if @current_user.write?(:kapa_case_actions) %>
                <% end %>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

<% end %>
